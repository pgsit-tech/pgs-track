<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGS Tracking System - 身份验证</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6.x -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
        }
        
        .auth-header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .auth-body {
            padding: 2rem;
        }
        
        .qr-code {
            text-align: center;
            margin: 2rem 0;
            position: relative;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .qr-code canvas,
        .qr-code img {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            max-width: 100%;
            height: auto;
        }

        .qr-code p {
            margin: 10px 0 0 0;
            font-size: 14px;
            color: #6b7280;
        }
        
        .secret-key {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 1rem 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: -1;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .step.active .step-number {
            background: #2563eb;
            color: white;
        }
        
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        
        .step-text {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .step.active .step-text {
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="auth-card">
        <div class="auth-header">
            <h3 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>
                后台管理认证
            </h3>
            <p class="mb-0 mt-2 opacity-75">PGS系统使用Google Authenticator进行双重验证</p>
        </div>
        
        <div class="auth-body">
            <!-- 步骤指示器 -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">扫描二维码</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">输入验证码</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">访问后台</div>
                </div>
            </div>
            
            <!-- 初始设置界面 -->
            <div id="setupView">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    首次访问需要设置Google Authenticator
                </div>
                
                <h5 class="mb-3">步骤1: 扫描二维码</h5>
                <p class="text-muted">使用Google Authenticator应用扫描下方二维码：</p>
                
                <div class="qr-code">
                    <div id="qrcode"></div>
                </div>
                
                <h6 class="mb-2">或手动输入密钥：</h6>
                <div class="secret-key" id="secretKey" style="position: relative;">
                    <!-- 动态生成的密钥 -->
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; font-size: 11px;"
                            onclick="copySecret()" title="复制密钥">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="showVerifyStep()">
                        <i class="fas fa-arrow-right me-2"></i>
                        下一步：验证设置
                    </button>
                </div>
            </div>
            
            <!-- 验证界面 -->
            <div id="verifyView" class="d-none">
                <h5 class="mb-3">步骤2: 输入验证码</h5>
                <p class="text-muted">请输入Google Authenticator中显示的6位验证码：</p>
                
                <form id="verifyForm">
                    <div class="mb-3">
                        <label for="verifyCode" class="form-label">验证码</label>
                        <input type="text" class="form-control form-control-lg text-center" 
                               id="verifyCode" 
                               placeholder="000000" 
                               maxlength="6" 
                               pattern="[0-9]{6}"
                               autocomplete="off">
                        <div class="form-text">验证码每30秒更新一次</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" id="verifyBtn">
                            <i class="fas fa-check me-2"></i>
                            验证并进入后台
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="showSetupStep()">
                            <i class="fas fa-arrow-left me-2"></i>
                            返回上一步
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- 登录界面 -->
            <div id="loginView" class="d-none">
                <h5 class="mb-3">身份验证</h5>
                <p class="text-muted">请输入Google Authenticator中的验证码：</p>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginCode" class="form-label">验证码</label>
                        <input type="text" class="form-control form-control-lg text-center" 
                               id="loginCode" 
                               placeholder="000000" 
                               maxlength="6" 
                               pattern="[0-9]{6}"
                               autocomplete="off">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            登录后台
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="resetAuth()">
                            <i class="fas fa-redo me-2"></i>
                            重置认证设置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            onerror="console.warn('Bootstrap CDN加载失败，使用备用方案')"></script>
    
    <!-- QR Code Generator (Local) -->
    <script src="../js/qrcode.min.js"></script>

    <!-- TOTP Library (Local) -->
    <script src="../js/otpauth.min.js"></script>
    
    <!-- Authentication JavaScript -->
    <script src="auth.js"></script>
</body>
</html>
